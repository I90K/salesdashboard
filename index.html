<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insurance Sales Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1B4965;
            --secondary-color: #00B5E2;
            --success-color: #2ACB6C;
            --warning-color: #FFD000;
            --dnq-color: #FF6B6B;
            --danger-color: #FF6B6B;
            --bg-color: #F5F5F5;
            --card-bg: #FFFFFF;
            --text-primary: #333;
            --text-secondary: #666;
            --modal-overlay: rgba(0, 0, 0, 0.5);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Baloo 2', sans-serif;
            line-height: 1.6;
            padding: 15px;
            background-color: var(--bg-color);
        }

        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Metrics Section */
        .metrics-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: var(--card-bg);
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .metric-card:hover {
            transform: translateY(-2px);
        }

        .metric-card h3 {
            color: var(--primary-color);
            margin-bottom: 8px;
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--text-secondary);
        }

        .progress-bar {
            width: 100%;
            height: 15px;
            background-color: #ddd;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress {
            height: 100%;
            background-color: var(--success-color);
            transition: width 0.3s ease;
        }

        /* Form Container */
        .form-container {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .notes-section {
            margin: 15px 0;
        }

        .notes-section textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            resize: vertical;
            font-family: 'Baloo 2', sans-serif;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-primary);
            font-size: 0.9em;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9em;
            font-family: 'Baloo 2', sans-serif;
        }

        input[type="checkbox"] {
            width: auto;
            transform: scale(1.2);
            margin-right: 4px;
        }

        /* Products Section */
        .products-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .products-section .form-grid {
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            align-items: center;
        }

        .product-icon {
            font-size: 1.2em;
            color: var(--primary-color);
            margin-right: 4px;
        }

        /* Form Layout */
        .final-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr) auto;
            gap: 10px;
            align-items: flex-end;
            margin-bottom: 15px;
        }

        .final-row button[type="submit"] {
            height: 38px;
            margin-top: 21px;
        }

        .center-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        /* Button Styles */
        button {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            font-size: 0.9em;
            transition: all 0.2s ease;
            font-family: 'Baloo 2', sans-serif;
        }

        button:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .action-btn.schedule {
            background-color: var(--warning-color);
            color: var(--text-primary);
        }

        .action-btn.email {
            background-color: var(--secondary-color);
            color: white;
        }

        .action-btn.bind-check {
            background-color: var(--success-color);
            color: white;
        }

        /* Filter and Controls */
        .controls-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
        }

        .filter-container {
            display: flex;
            gap: 5px;
        }

        .sort-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-btn, .sort-select {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            background-color: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid #ddd;
        }

        .filter-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        .export-btn {
            background-color: var(--success-color);
        }

        .import-btn {
            background-color: var(--secondary-color);
        }

        .reset-btn {
            background-color: var(--danger-color);
        }

        /* Call Cards */
        .calls-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .call-card {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .call-card.bind {
            border-left: 4px solid var(--success-color);
        }

        .call-card.follow {
            border-left: 4px solid var(--warning-color);
        }

        .call-card.dnq {
            border-left: 4px solid var(--dnq-color);
        }

        .call-card.not {
            border-left: 4px solid var(--danger-color);
        }

        .call-card-content {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto;
            gap: 10px;
            align-items: center;
        }

        .call-notes {
            display: none;
            padding: 10px;
            margin-top: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .call-card.expanded .call-notes {
            display: block;
        }

        /* Status Indicators */
        .status-bind {
            color: var(--success-color);
            font-weight: bold;
        }

        .status-follow {
            color: var(--warning-color);
            font-weight: bold;
        }

        .status-dnq {
            color: var(--dnq-color);
            font-weight: bold;
        }

        .status-not {
            color: var(--danger-color);
            font-weight: bold;
        }

        /* Bottom Section */
        .bottom-section {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-overlay);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--text-secondary);
        }

        /* Email Templates */
        .email-templates {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .template-option {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .template-option:hover {
            border-color: var(--primary-color);
            background-color: #f8f9fa;
        }

        .template-option.selected {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Reminder Options */
        .reminder-options {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .reminder-option {
            flex: 1;
            padding: 10px 15px;
            background: none;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            color: var(--text-primary);  /* Add this line */
            font-family: 'Baloo 2', sans-serif;
        }

        .reminder-option:hover {
            border-color: var(--primary-color);
            background-color: #f8f9fa;
        }

        .reminder-option.selected {
            background-color: var(--primary-color);
            color: white;  /* This stays white for selected state */
            border-color: var(--primary-color);
        }

        /* Callback Management */
        .callback-section {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .callback-indicator {
            background-color: var(--warning-color);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }

        .callback-edit-btn,
        .callback-delete-btn {
            padding: 4px 8px;
            font-size: 0.8em;
            border-radius: 4px;
            background: none;
            border: 1px solid #ddd;
        }

        .callback-edit-btn:hover {
            background-color: var(--warning-color);
            color: white;
            border-color: var(--warning-color);
        }

        .callback-delete-btn:hover {
            background-color: var(--danger-color);
            color: white;
            border-color: var(--danger-color);
        }

        /* Bind Check Styles */
        .checklist-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            padding: 8px;
            border-radius: 6px;
            background: #f8f9fa;
        }

        .checklist-item input[type="checkbox"] {
            margin-right: 10px;
            margin-top: 4px;
        }

        .checklist-item label {
            flex: 1;
            cursor: pointer;
        }

        .checklist-item.completed {
            background: #e8f5e9;
        }
    </style>
</head>

<body>
    <div class="dashboard">
        <!-- Metrics Section -->
        <div class="metrics-container">
            <div class="metric-card">
                <h3><i class="fas fa-award"></i> Points (Sold)</h3>
                <div class="metric-value" id="points-sold">0</div>
                <div class="progress-bar">
                    <div class="progress" id="points-progress" style="width: 0%"></div>
                </div>
            </div>
            <div class="metric-card">
                <h3><i class="fas fa-headset"></i> Calls</h3>
                <div class="metric-value" id="total-calls">0</div>
            </div>
            <div class="metric-card">
                <h3><i class="fas fa-bullseye"></i> ITC</h3>
                <div class="metric-value" id="itc-rate">0%</div>
            </div>
            <div class="metric-card">
                <h3><i class="fas fa-clipboard-check"></i> Points Quoted</h3>
                <div class="metric-value" id="points-quoted">0</div>
            </div>
            <div class="metric-card">
                <h3><i class="fas fa-coins"></i> Dollars Earned</h3>
                <div class="metric-value" id="dollars-earned">$0</div>
            </div>
        </div>

        <!-- Form Container -->
        <div class="form-container">
            <form id="call-form">
                <!-- Basic Info -->
                <div class="form-grid">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="customer" required>
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="phone">
                    </div>
                    <div class="form-group">
                        <label>State</label>
                        <input type="text" id="state" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="email">
                    </div>
                </div>

                <!-- Notes Section -->
                <div class="notes-section">
                    <label>Notes</label>
                    <textarea id="notes"></textarea>
                </div>

                <!-- Products Section -->
                <div class="products-section">
                    <div class="form-grid">
                        <div class="form-group">
                            <i class="fas fa-home product-icon"></i>
                            <input type="checkbox" id="homeowners"> (2.5)
                        </div>
                        <div class="form-group">
                            <i class="fas fa-car product-icon"></i>
                            <input type="number" id="auto-count" min="0" value="0" style="width: 50px;"> (1.0)
                        </div>
                        <div class="form-group">
                            <i class="fas fa-motorcycle product-icon"></i>
                            <input type="checkbox" id="specialty-auto"> (0.7)
                        </div>
                        <div class="form-group">
                            <i class="fas fa-building product-icon"></i>
                            <input type="checkbox" id="renters"> (0.5)
                        </div>
                        <div class="form-group">
                            <i class="fas fa-umbrella product-icon"></i>
                            <input type="checkbox" id="umbrella"> (0.5)
                        </div>
                        <div class="form-group">
                            <i class="fas fa-key product-icon"></i>
                            <input type="checkbox" id="landlord"> (0.5)
                        </div>
                        <div class="form-group">
                            <i class="fas fa-caravan product-icon"></i>
                            <input type="checkbox" id="manufactured"> (0.5)
                        </div>
                    </div>
                </div>

                <!-- Final Row -->
                <div class="final-row">
                    <div class="form-group">
                        <label>Current Provider</label>
                        <input type="text" id="provider">
                    </div>
                    <div class="form-group">
                        <label>Language</label>
                        <select id="language">
                            <option value="English">English</option>
                            <option value="Spanish">Spanish</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Outcome</label>
                        <select id="outcome">
                            <option value="Bind">Bind</option>
                            <option value="Follow Up">Follow Up</option>
                            <option value="DNQ">DNQ</option>
                            <option value="Not Interested">Not Interested</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Last Contacted</label>
                        <input type="datetime-local" id="last-contacted">
                    </div>
                    <div class="form-group">
                        <button type="submit">Add Entry</button>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="center-buttons">
                    <button type="button" class="action-btn schedule" onclick="openCallbackModal()">
                        <i class="fas fa-calendar"></i> Schedule Callback
                    </button>
                    <button type="button" class="action-btn email" onclick="openEmailModal()">
                        <i class="fas fa-envelope"></i> Email Prospect
                    </button>
                    <button type="button" class="action-btn bind-check" onclick="openBindCheckModal()">
                        <i class="fas fa-check-double"></i> Bind Check
                    </button>
                </div>
            </form>
        </div>

        <!-- Filter and Sort Controls -->
        <div class="controls-container">
            <div class="filter-container">
                <button class="filter-btn active" data-filter="all">All Calls</button>
                <button class="filter-btn" data-filter="bind">Binds</button>
                <button class="filter-btn" data-filter="follow">Follow Ups</button>
                <button class="filter-btn" data-filter="callbacks">Callbacks</button>
                <button class="filter-btn" data-filter="dnq">DNQ</button>
                <button class="filter-btn" data-filter="not">Not Interested</button>
            </div>
            <div class="sort-container">
                <label>Sort by:</label>
                <select id="sort-select" onchange="applySorting()">
                    <option value="dateCreated">Date Created</option>
                    <option value="lastModified">Last Modified</option>
                    <option value="lastContacted">Last Contacted</option>
                </select>
            </div>
        </div>

        <!-- Calls Grid -->
        <div class="calls-grid" id="calls-container"></div>

        <!-- Bottom Actions -->
        <div class="bottom-section">
            <button class="reset-btn" onclick="resetMonth()">
                <i class="fas fa-sync"></i> Reset For New Month
            </button>
            <button class="export-btn" onclick="exportToExcel()">
                <i class="fas fa-file-export"></i> Export to Excel
            </button>
            <button class="import-btn" onclick="document.getElementById('excel-file').click()">
                <i class="fas fa-file-import"></i> Import from Excel
            </button>
        </div>
    </div>

    <!-- Hidden File Input -->
    <input type="file" id="excel-file" accept=".xlsx,.xls" style="display: none;">

<!-- Callback Modal -->
    <div id="callback-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Schedule Callback</h3>
                <button class="modal-close" onclick="closeModal('callback-modal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Callback Date & Time</label>
                <input type="text" id="callback-datetime" class="flatpickr">
            </div>
            <div class="form-group">
                <label>Set Reminder(s)</label>
                <div class="reminder-options">
                    <button type="button" class="reminder-option" data-minutes="15" onclick="toggleReminder(this)">
                        15 min before
                    </button>
                    <button type="button" class="reminder-option" data-minutes="30" onclick="toggleReminder(this)">
                        30 min before
                    </button>
                    <button type="button" class="reminder-option" data-minutes="60" onclick="toggleReminder(this)">
                        1 hour before
                    </button>
                </div>
            </div>
            <button onclick="scheduleCallback()" class="action-btn schedule">Schedule Callback</button>
        </div>
    </div>

    <!-- Email Modal -->
    <!-- Email Modal -->
    <div id="email-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Email Templates</h3>
                <button class="modal-close" onclick="closeModal('email-modal')">&times;</button>
            </div>
            <div class="email-templates">
                <!-- Spanish Templates -->
                <div class="template-group">
                    <h4>Spanish Templates</h4>
                    <div class="template-option" onclick="selectEmailTemplate('llamada')" data-subject="Llamada de Allstate" data-body="Hola [name],

Te llamé ahora mismo para revisar las cotizaciones actualizadas. Si hay un mejor horario o un número diferente al que pueda llamarte, por favor avísame.

Linea Directa:
866-512-0606 Ext 1140551

Gracias,">
                        Llamada de Allstate
                    </div>
                    <div class="template-option" onclick="selectEmailTemplate('cita')" data-subject="Cita de Allstate" data-body="Hola [name],

Te llamaré para nuestra cita en breve. Estoy terminando una cita y te llamaré en aproximadamente 2 minutos. El número desde el que llamaré será un número 1-800.

Gracias,">
                        Cita de Allstate
                    </div>
                    <div class="template-option" onclick="selectEmailTemplate('documentos-es')" data-subject="Documentos de Allstate" data-body="Hola [name],

Fue un placer hablar con ustedes hoy para discutir sus necesidades de seguro. Adjunto está tus documentos de seguro.

Gracias,">
                        Documentos de Allstate
                    </div>
                    <div class="template-option" onclick="selectEmailTemplate('cotizacion-es')" data-subject="Cotización de Allstate" data-body="Hola [name],

Fue un placer hablar con usted hoy para discutir sus necesidades de seguro. Espero poder charlar pronto.

Gracias,">
                        Cotización de Allstate
                    </div>
                    <div class="template-option" onclick="selectEmailTemplate('agente')" data-subject="Agente de Allstate" data-body="Hola [name],

Fue un placer hablar con ustedes hoy para discutir sus necesidades de seguro.

Linea Directa:
866-512-0606 Ext 1140551

Gracias,">
                        Agente de Allstate
                    </div>
                </div>

                <!-- English Templates -->
                <div class="template-group">
                    <h4>English Templates</h4>
                    <div class="template-option" onclick="selectEmailTemplate('voicemail')" data-subject="Allstate Voicemail" data-body="Hi [name],

I left you a voicemail right now. If there is a better time or different number I can give you a call at please let me know.

Direct Line:
866-512-0606 Ext 1140551

Thank you,">
                        Allstate Voicemail
                    </div>
                    <div class="template-option" onclick="selectEmailTemplate('phone')" data-subject="Allstate Phone Call" data-body="Hi [name],

I will be giving you a call as promised here shortly. I am finishing up an appointment and will call you in about 2 minutes. The call will come in from a 1-800 Allstate Toll Free Number.

Thank you,">
                        Allstate Phone Call
                    </div>
                    <div class="template-option" onclick="selectEmailTemplate('documents')" data-subject="Allstate Documents" data-body="Hi [name],

I appreciate your patience and trust today! Attached are your insurance documents.

Thank you,">
                        Allstate Documents
                    </div>
                    <div class="template-option" onclick="selectEmailTemplate('quote')" data-subject="Allstate Quote" data-body="Hi [name],

It was a pleasure speaking with you today to discuss your insurance needs! Attached is the quote we reviewed. I look forward to chatting soon.

Thank you,">
                        Allstate Quote
                    </div>
                    <div class="template-option" onclick="selectEmailTemplate('agent')" data-subject="Allstate Agent" data-body="Hi [name],

It was a pleasure speaking with you today to discuss your insurance needs.

Direct Line:
866-512-0606 Ext 1140551

Thank you,">
                        Allstate Agent
                    </div>
                </div>
            </div>
            <div class="form-group" style="margin-top: 20px;">
                <button onclick="sendEmail()" class="action-btn email">Send Email</button>
            </div>
        </div>
    </div>

    <!-- Bind Check Modal -->
    <div id="bind-check-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Bind Requirements Checklist</h3>
                <button class="modal-close" onclick="closeModal('bind-check-modal')">&times;</button>
            </div>
            <div id="bind-checklist">
                <div class="checklist-item">
                    <input type="checkbox" id="auth-check">
                    <label for="auth-check">Authentication - Full Name/Full Address, phone number/DOB, email (must come from customer)</label>
                </div>
                <div class="checklist-item">
                    <input type="checkbox" id="name-check">
                    <label for="name-check">Spelling of Name</label>
                </div>
                <div class="checklist-item">
                    <input type="checkbox" id="drivers-check">
                    <label for="drivers-check">Additional Drivers - "Will there be any other drivers in your household?"</label>
                </div>
                <div class="checklist-item">
                    <input type="checkbox" id="quote-check">
                    <label for="quote-check">Existing Quote - Verify listed drivers, excluded drivers, and verify age licensed</label>
                </div>
                <div class="checklist-item">
                    <input type="checkbox" id="vin-check">
                    <label for="vin-check">VIN - Verify Last 4/2(ASC) Digits</label>
                </div>
                <div class="checklist-item">
                    <input type="checkbox" id="license-check">
                    <label for="license-check">License - Last 4 Digits(Legacy)</label>
                </div>
                <div class="checklist-item">
                    <input type="checkbox" id="prior-check">
                    <label for="prior-check">Prior insurance - Name, length, policy number, dec page for declared(ASC)</label>
                </div>
                <div class="checklist-item">
                    <input type="checkbox" id="reports-check">
                    <label for="reports-check">Consumer reports reviewed</label>
                </div>
                <div class="checklist-item">
                    <input type="checkbox" id="drivewise-check">
                    <label for="drivewise-check">Drivewise - qualify and advise</label>
                </div>
                <div class="checklist-item">
                    <input type="checkbox" id="coverages-check">
                    <label for="coverages-check">Coverages - Mention ALL coverages, Pitch higher limits and advise risk of having state min, review rejected coverages</label>
                </div>
                <div class="checklist-item">
                    <input type="checkbox" id="date-check">
                    <label for="date-check">Effective date</label>
                </div>
                <div class="checklist-item">
                    <input type="checkbox" id="owners-check">
                    <label for="owners-check">Registered owners - Mention vehicles individually and ask who the registered owner is, add lienholder</label>
                </div>
                <div class="checklist-item">
                    <input type="checkbox" id="scripts-check">
                    <label for="scripts-check">Scripts - Read all required scripting</label>
                </div>
                <div class="checklist-item">
                    <input type="checkbox" id="price-check">
                    <label for="price-check">Final price - include installment fees</label>
                </div>
                <div class="checklist-item">
                    <input type="checkbox" id="payment-check">
                    <label for="payment-check">Payment - Debit/credit card with autopay. Payments without autopay must be approved by RA or manager and must be documented</label>
                </div>
            </div>
            <button onclick="verifyBindChecklist()" class="action-btn bind-check">Verify Checklist</button>
        </div>
    </div>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Application JavaScript Part 1 -->
    <script>
        // Global Variables
        let callsData = JSON.parse(localStorage.getItem('callsData')) || [];
        const GOAL_POINTS = 200;
        let editingIndex = -1;
        let selectedReminders = new Set();
        let flatpickrInstance;
        let selectedEmailTemplate = null;

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            updateMetrics();
            displayCalls();
            initializeFlatpickr();
            setupEventListeners();
            checkForUpcomingCallbacks();
           
            // Request notification permission
            if (Notification.permission !== 'granted') {
                Notification.requestPermission();
            }
        });

        // Setup and Initialization Functions
        function initializeFlatpickr() {
            flatpickrInstance = flatpickr("#callback-datetime", {
                enableTime: true,
                dateFormat: "Y-m-d H:i",
                minDate: "today",
                time_24hr: false,
                minuteIncrement: 15
            });
        }

        function setupEventListeners() {
            // Form submission
            document.getElementById('call-form').addEventListener('submit', handleSubmit);
           
            // Filter buttons
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    displayCalls(this.dataset.filter);
                });
            });

            // Call card expansion
            document.getElementById('calls-container').addEventListener('click', function(e) {
                const card = e.target.closest('.call-card');
                if (card && !e.target.closest('.call-actions')) {
                    card.classList.toggle('expanded');
                }
            });

            // Excel file import
            document.getElementById('excel-file').addEventListener('change', handleFileSelect);

            // Bind checklist items
            document.querySelectorAll('.checklist-item input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    this.closest('.checklist-item').classList.toggle('completed', this.checked);
                });
            });

            // Sort select
            document.getElementById('sort-select').addEventListener('change', applySorting);
        }

        // Data Calculation Functions
        function calculatePoints(formData) {
            let points = 0;
            if (formData.homeowners) points += 2.5;
            points += formData.autoCount * 1;
            if (formData.specialtyAuto) points += 0.7;
            if (formData.renters) points += 0.5;
            if (formData.umbrella) points += 0.5;
            if (formData.landlord) points += 0.5;
            if (formData.manufactured) points += 0.5;
            return points;
        }

        function calculateTierAmount(points) {
            if (points <= 45) return 0;
            let amount = 0;
            if (points > 45 && points <= 68) amount = (points - 45) * 10;
            if (points > 68 && points <= 90) amount = (68 - 45) * 10 + (points - 68) * 25;
            if (points > 90 && points <= 135) amount = (68 - 45) * 10 + (90 - 68) * 25 + (points - 90) * 40;
            if (points > 135 && points <= 158) amount = (68 - 45) * 10 + (90 - 68) * 25 + (135 - 90) * 40 + (points - 135) * 55;
            if (points > 158 && points <= 203) amount = (68 - 45) * 10 + (90 - 68) * 25 + (135 - 90) * 40 + (158 - 135) * 55 + (points - 158) * 60;
            if (points > 203) amount = (68 - 45) * 10 + (90 - 68) * 25 + (135 - 90) * 40 + (158 - 135) * 55 + (203 - 158) * 60 + (points - 203) * 65;
            return amount;
        }

        // Update Display Functions
        function updateMetrics() {
            const totalCalls = callsData.length;
            const bindCalls = callsData.filter(call => call.outcome === "Bind").length;
           
            const pointsSold = callsData
                .filter(call => call.outcome === "Bind")
                .reduce((sum, call) => sum + call.points, 0);
           
            const pointsQuoted = callsData.reduce((sum, call) => sum + call.points, 0);
           
            const itcRate = totalCalls ? ((bindCalls / totalCalls) * 100).toFixed(1) : 0;
           
            document.getElementById('points-sold').textContent = pointsSold.toFixed(1);
            document.getElementById('total-calls').textContent = totalCalls;
            document.getElementById('itc-rate').textContent = itcRate + '%';
            document.getElementById('points-quoted').textContent = pointsQuoted.toFixed(1);
            document.getElementById('dollars-earned').textContent = '$' + calculateTierAmount(pointsSold).toFixed(2);
           
            const progressPercentage = (pointsSold / GOAL_POINTS) * 100;
            document.getElementById('points-progress').style.width = Math.min(progressPercentage, 100) + '%';
        }

        function displayCalls(filter = 'all') {
            const container = document.getElementById('calls-container');
            container.innerHTML = '';

            const sortedCalls = getSortedCalls();

            sortedCalls.forEach((call, index) => {
                if (filter !== 'all') {
                    if (filter === 'callbacks' && !call.callback) return;
                    if (filter !== 'callbacks' && !call.outcome.toLowerCase().includes(filter.toLowerCase())) return;
                }

                const card = document.createElement('div');
                card.className = `call-card ${call.outcome.toLowerCase().replace(' ', '-')}`;
               
                let callbackBadge = '';
                if (call.callback) {
                    const callbackDate = new Date(call.callback);
                    callbackBadge = `
                        <div class="callback-section">
                            <span class="callback-indicator">Callback: ${callbackDate.toLocaleString()}</span>
                            <button onclick="editCallback(${callsData.length - 1 - index})" class="callback-edit-btn">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteCallback(${callsData.length - 1 - index})" class="callback-delete-btn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div class="call-card-content">
                        <div>
                            <strong>${call.customer}</strong>
                            <div>${call.phone}</div>
                            ${callbackBadge}
                        </div>
                        <div>${call.state}</div>
                        <div>${getProductsList(call)}</div>
                        <div>Points: ${call.points.toFixed(1)}</div>
                        <div class="status-${call.outcome.toLowerCase().replace(' ', '-')}">${call.outcome}</div>
                        <div class="call-actions">
                            <button onclick="editCall(${callsData.length - 1 - index})" class="edit-btn">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteCall(${callsData.length - 1 - index})" class="delete-btn">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="call-notes">
                        <strong>Notes:</strong><br>
                        ${call.notes || 'No notes available'}
                        <hr>
                        <div class="call-details">
                            <div><strong>Email:</strong> ${call.email || 'N/A'}</div>
                            <div><strong>Provider:</strong> ${call.provider || 'N/A'}</div>
                            <div><strong>Language:</strong> ${call.language}</div>
                            <div><strong>Date Created:</strong> ${call.date}</div>
                            ${call.lastContacted ? `<div><strong>Last Contacted:</strong> ${new Date(call.lastContacted).toLocaleString()}</div>` : ''}
                            ${call.lastModified ? `<div><strong>Last Modified:</strong> ${new Date(call.lastModified).toLocaleString()}</div>` : ''}
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Form Handling Functions
        function handleSubmit(event) {
            event.preventDefault();

            const formData = {
                date: editingIndex >= 0 ? callsData[editingIndex].date : new Date().toLocaleDateString(),
                customer: document.getElementById('customer').value,
                phone: document.getElementById('phone').value,
                state: document.getElementById('state').value,
                email: document.getElementById('email').value,
                notes: document.getElementById('notes').value,
                lastContacted: document.getElementById('last-contacted').value,
                homeowners: document.getElementById('homeowners').checked,
                autoCount: parseInt(document.getElementById('auto-count').value) || 0,
                specialtyAuto: document.getElementById('specialty-auto').checked,
                renters: document.getElementById('renters').checked,
                umbrella: document.getElementById('umbrella').checked,
                landlord: document.getElementById('landlord').checked,
                manufactured: document.getElementById('manufactured').checked,
                provider: document.getElementById('provider').value,
                language: document.getElementById('language').value,
                outcome: document.getElementById('outcome').value,
                callback: null,
                reminders: [],
                lastModified: new Date().toISOString()
            };

            formData.points = calculatePoints(formData);

            if (editingIndex >= 0) {
                formData.callback = callsData[editingIndex].callback;
                formData.reminders = callsData[editingIndex].reminders || [];
                callsData[editingIndex] = formData;
                editingIndex = -1;
                document.querySelector('button[type="submit"]').textContent = 'Add Entry';
            } else {
                callsData.push(formData);
            }
           
            localStorage.setItem('callsData', JSON.stringify(callsData));
            updateMetrics();
            displayCalls();
            event.target.reset();
        }

        function editCall(index) {
            editingIndex = index;
            const call = callsData[index];
           
            document.getElementById('customer').value = call.customer;
            document.getElementById('phone').value = call.phone;
            document.getElementById('state').value = call.state;
            document.getElementById('email').value = call.email;
            document.getElementById('notes').value = call.notes;
            document.getElementById('last-contacted').value = call.lastContacted || '';
            document.getElementById('homeowners').checked = call.homeowners;
            document.getElementById('auto-count').value = call.autoCount;
            document.getElementById('specialty-auto').checked = call.specialtyAuto;
            document.getElementById('renters').checked = call.renters;
            document.getElementById('umbrella').checked = call.umbrella;
            document.getElementById('landlord').checked = call.landlord;
            document.getElementById('manufactured').checked = call.manufactured;
            document.getElementById('provider').value = call.provider;
            document.getElementById('language').value = call.language;
            document.getElementById('outcome').value = call.outcome;
           
            const submitButton = document.querySelector('button[type="submit"]');
            submitButton.textContent = 'Update Entry';
           
            document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteCall(index) {
            if (confirm('Are you sure you want to delete this entry?')) {
                callsData.splice(index, 1);
                localStorage.setItem('callsData', JSON.stringify(callsData));
                updateMetrics();
                displayCalls();
            }
        }

        // Sorting Functions
        function getSortedCalls() {
            const sortBy = document.getElementById('sort-select').value;
            const calls = [...callsData].reverse();  // Start with newest first

            switch (sortBy) {
                case 'dateCreated':
                    return calls;  // Already sorted by creation date (newest first)
                case 'lastModified':
                    return calls.sort((a, b) => new Date(b.lastModified || 0) - new Date(a.lastModified || 0));
                case 'lastContacted':
                    return calls.sort((a, b) => new Date(b.lastContacted || 0) - new Date(a.lastContacted || 0));
                default:
                    return calls;
            }
        }

        function applySorting() {
            displayCalls(document.querySelector('.filter-btn.active').dataset.filter);
        }
    </script>

<!-- Application JavaScript Part 2 -->
    <script>
        // Modal Functions
        function openCallbackModal() {
            if (editingIndex < 0) {
                alert('Please select a call record first');
                return;
            }
            const modal = document.getElementById('callback-modal');
            modal.classList.add('active');
            flatpickrInstance.clear();
            selectedReminders.clear();
            document.querySelectorAll('.reminder-option').forEach(opt => opt.classList.remove('selected'));
        }

        function openEmailModal() {
            if (editingIndex < 0) {
                alert('Please select a call record first');
                return;
            }

            const call = callsData[editingIndex];
            if (!call.email) {
                alert('No email address available for this prospect');
                return;
            }

            selectedEmailTemplate = null;
            document.querySelectorAll('.template-option').forEach(opt => opt.classList.remove('selected'));
            const modal = document.getElementById('email-modal');
            modal.classList.add('active');
        }

        function openBindCheckModal() {
            const modal = document.getElementById('bind-check-modal');
            modal.classList.add('active');
            document.querySelectorAll('.checklist-item input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
                checkbox.closest('.checklist-item').classList.remove('completed');
            });
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Email Template Functions
function getFirstName(fullName) {
    return fullName.split(' ')[0];
}
        function selectEmailTemplate(templateId) {
            selectedEmailTemplate = templateId;
            document.querySelectorAll('.template-option').forEach(opt => {
                opt.classList.toggle('selected', opt.getAttribute('onclick').includes(templateId));
            });
        }

        function sendEmail() {
    if (!selectedEmailTemplate) {
        alert('Please select an email template');
        return;
    }

    const call = callsData[editingIndex];
    const firstName = getFirstName(call.customer);
    const templateElement = document.querySelector(`.template-option[onclick*="${selectedEmailTemplate}"]`);
    const subject = templateElement.getAttribute('data-subject');
    const body = templateElement.getAttribute('data-body').replace('[name]', firstName);

    const mailtoLink = `mailto:${call.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.location.href = mailtoLink;
    closeModal('email-modal');
}

        // Callback Management Functions
        function toggleReminder(element) {
            element.classList.toggle('selected');
            const minutes = element.dataset.minutes;
           
            if (element.classList.contains('selected')) {
                selectedReminders.add(minutes);
            } else {
                selectedReminders.delete(minutes);
            }
        }

        function scheduleCallback() {
            if (editingIndex < 0) {
                alert('Please select a call record first');
                return;
            }

            const callbackDate = flatpickrInstance.selectedDates[0];
            if (!callbackDate) {
                alert('Please select a date and time for the callback');
                return;
            }

            callsData[editingIndex].callback = callbackDate.toISOString();
            callsData[editingIndex].reminders = Array.from(selectedReminders);
            callsData[editingIndex].lastModified = new Date().toISOString();
           
            localStorage.setItem('callsData', JSON.stringify(callsData));
           
            scheduleNotifications(callsData[editingIndex]);
            createOutlookEvent(callsData[editingIndex]);
           
            closeModal('callback-modal');
            displayCalls();
        }

        function editCallback(index) {
            editingIndex = index;
            const call = callsData[index];
           
            const modal = document.getElementById('callback-modal');
            modal.classList.add('active');
           
            if (call.callback) {
                flatpickrInstance.setDate(new Date(call.callback));
            }
           
            selectedReminders.clear();
            document.querySelectorAll('.reminder-option').forEach(opt => {
                const minutes = opt.dataset.minutes;
                if (call.reminders && call.reminders.includes(minutes)) {
                    opt.classList.add('selected');
                    selectedReminders.add(minutes);
                } else {
                    opt.classList.remove('selected');
                }
            });
        }

        function deleteCallback(index) {
            if (confirm('Are you sure you want to delete this callback?')) {
                callsData[index].callback = null;
                callsData[index].reminders = [];
                callsData[index].lastModified = new Date().toISOString();
                localStorage.setItem('callsData', JSON.stringify(callsData));
                displayCalls();
            }
        }

       function createOutlookEvent(call) {
    const startDate = new Date(call.callback);
    const endDate = new Date(startDate.getTime() + (60 * 60 * 1000)); // 1 hour duration

    // Format dates in the required format: YYYYMMDDTHHMMSSZ
    const formatDate = (date) => {
        return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
    };

    const subject = encodeURIComponent(`Callback - ${call.customer}`);
    const startTime = formatDate(startDate);
    const endTime = formatDate(endDate);
    const body = encodeURIComponent(`Callback appointment for ${call.customer}\n\nPhone: ${call.phone}\nEmail: ${call.email}\nNotes: ${call.notes}`);
    const location = encodeURIComponent('Phone Call');

    // Create the Outlook protocol URL
    const outlookUrl = `outlook:calendar/action=compose&subject=${subject}&starttime=${startTime}&endtime=${endTime}&location=${location}&body=${body}`;
   
    try {
        window.location.href = outlookUrl;
    } catch (error) {
        // Fallback to web version if desktop app fails
        const webOutlookUrl = `https://outlook.office.com/calendar/0/deeplink/compose?subject=${subject}&startdt=${startTime}&enddt=${endTime}&body=${body}&location=${location}`;
        window.open(webOutlookUrl, '_blank');
    }
}

        // Notification Functions
        function scheduleNotifications(call) {
            if (Notification.permission !== 'granted') return;

            call.reminders.forEach(minutes => {
                const reminderTime = new Date(call.callback);
                reminderTime.setMinutes(reminderTime.getMinutes() - parseInt(minutes));
               
                const timeUntilReminder = reminderTime.getTime() - new Date().getTime();
                if (timeUntilReminder > 0) {
                    setTimeout(() => {
                        new Notification('Callback Reminder', {
                            body: `Upcoming callback with ${call.customer} in ${minutes} minutes`,
                            icon: '/favicon.ico'
                        });
                    }, timeUntilReminder);
                }
            });
        }

        function checkForUpcomingCallbacks() {
            setInterval(() => {
                const now = new Date();
                callsData.forEach(call => {
                    if (call.callback) {
                        const callbackTime = new Date(call.callback);
                        const timeUntilCallback = callbackTime.getTime() - now.getTime();
                       
                        if (timeUntilCallback > 0 && timeUntilCallback <= 60000) {
                            new Notification('Immediate Callback Alert', {
                                body: `Callback with ${call.customer} is starting now!`,
                                icon: '/favicon.ico'
                            });
                        }
                    }
                });
            }, 30000);
        }

        // Excel Functions
        function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {
                type: 'array',
                cellDates: true,
                dateNF: 'yyyy-mm-dd'
            });
           
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            // Use sheet_to_json with raw: false to handle dates better
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
                raw: false,
                dateNF: 'yyyy-mm-dd'
            });
           
            jsonData.forEach(row => {
                // Properly handle the Excel date
                let dateValue;
                try {
                    if (row.Date) {
                        // First try to parse as a direct date string
                        dateValue = new Date(row.Date);
                        if (isNaN(dateValue.getTime())) {
                            // If that fails, try to parse Excel serial number
                            const excelDate = parseInt(row.Date);
                            if (!isNaN(excelDate)) {
                                dateValue = new Date(Math.round((excelDate - 25569) * 86400 * 1000));
                            }
                        }
                    } else {
                        dateValue = new Date();
                    }
                } catch (error) {
                    console.error('Date parsing error:', error);
                    dateValue = new Date();
                }

                const callEntry = {
                    date: dateValue.toLocaleDateString(),
                    customer: row.Customer || '',
                    phone: row.Phone || '',
                    state: row.State || '',
                    email: row.Email || '',
                    notes: row.Notes || '',
                    lastContacted: row['Last Contacted'] || '',
                    homeowners: row.Products?.includes('Homeowners') || false,
                    autoCount: row.Products?.match(/Auto \((\d+)\)/)?.[1] || 0,
                    specialtyAuto: row.Products?.includes('Specialty Auto') || false,
                    renters: row.Products?.includes('Renters') || false,
                    umbrella: row.Products?.includes('Umbrella') || false,
                    landlord: row.Products?.includes('Landlord') || false,
                    manufactured: row.Products?.includes('Manufactured') || false,
                    provider: row.Provider || '',
                    language: row.Language || 'English',
                    outcome: row.Outcome || 'Follow Up',
                    points: parseFloat(row.Points) || 0,
                    callback: row.Callback || null,
                    reminders: [],
                    lastModified: new Date().toISOString()
                };
                callsData.push(callEntry);
            });

            localStorage.setItem('callsData', JSON.stringify(callsData));
            updateMetrics();
            displayCalls();
            alert('Data imported successfully!');
        } catch (error) {
            console.error('Error importing file:', error);
            alert('Error importing file. Please make sure it\'s a valid Excel file.');
        }
    };
    reader.readAsArrayBuffer(file);
}

        function exportToExcel() {
            let csv = '\ufeff';  // BOM for Excel
            csv += 'Date,Customer,Phone,State,Email,Notes,Products,Points,Provider,Language,Outcome,Last Contacted,Callback,Last Modified\n';
           
            callsData.forEach(call => {
                csv += `${[
                    call.date,
                    call.customer,
                    call.phone,
                    call.state,
                    call.email,
                    call.notes,
                    getProductsList(call),
                    call.points,
                    call.provider,
                    call.language,
                    call.outcome,
                    call.lastContacted ? new Date(call.lastContacted).toLocaleString() : '',
                    call.callback ? new Date(call.callback).toLocaleString() : '',
                    call.lastModified ? new Date(call.lastModified).toLocaleString() : ''
                ].map(field => `"${(field || '').toString().replace(/"/g, '""')}"`).join(',')}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `insurance_calls_${new Date().toLocaleDateString().replace(/\//g, '-')}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Utility Functions
        function getProductsList(call) {
            const products = [];
            if (call.homeowners) products.push('Homeowners');
            if (call.autoCount > 0) products.push(`Auto (${call.autoCount})`);
            if (call.specialtyAuto) products.push('Specialty Auto');
            if (call.renters) products.push('Renters');
            if (call.umbrella) products.push('Umbrella');
            if (call.landlord) products.push('Landlord');
            if (call.manufactured) products.push('Manufactured');
            return products.join(', ') || 'None';
        }

        function resetMonth() {
            if (confirm('Are you sure you want to reset all data for a new month? This action cannot be undone.')) {
                localStorage.removeItem('callsData');
                callsData = [];
                updateMetrics();
                displayCalls();
            }
        }

        function verifyBindChecklist() {
            const allChecked = Array.from(document.querySelectorAll('#bind-checklist input[type="checkbox"]'))
                .every(checkbox => checkbox.checked);

            if (allChecked) {
                alert('All requirements verified! You can proceed with binding.');
            } else {
                alert('Please complete all checklist items before binding.');
            }
            closeModal('bind-check-modal');
        }
    </script>
</body>
</html>
